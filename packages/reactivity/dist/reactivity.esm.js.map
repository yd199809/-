{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["import { Link } from \"./system\";\n\n// \u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684effect\nexport let activeSub;\n\nexport class ReactiveEffect {\n  // \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5934\u8282\u70B9\n  deps: Link | undefined;\n  // \u4F9D\u8D56\u9879\u94FE\u8868\u7684\u5C3E\u8282\u70B9\n  depsTail: Link | undefined;\n  constructor(public fn: () => void) {}\n  run() {\n    // \u5148\u5C06\u5F53\u524D\u7684 effect \u4FDD\u5B58\u8D77\u6765 \u7528\u4E8E\u5904\u7406\u5D4C\u5957\u7684\u903B\u8F91\n    const prevSub = activeSub;\n    // \u6BCF\u6B21\u6267\u884Cfn\u4E4B\u524D \u628Athis \u653E\u5230 activeSub\u4E0A\n    activeSub = this;\n    this.depsTail = undefined;\n    try {\n      return this.fn();\n    } finally {\n      // \u6267\u884C\u5B8C\u6BD5\u540E \u6062\u590D\n      activeSub = prevSub;\n    }\n  }\n\n  // \u901A\u77E5\u66F4\u65B0\u7684\u65B9\u6CD5 \u5982\u679C\u4F9D\u8D56\u7684\u6570\u636E\u53D1\u751F\u4E86\u53D8\u5316 \u4F1A\u8C03\u7528\u8FD9\u4E2A\u51FD\u6570\n\n  notify() {\n    this.scheduler();\n  }\n\n  // \u9ED8\u8BA4\u8C03\u7528 run \u5982\u679C\u7528\u6237\u4F20\u4E86 \u5C31\u4EE5\u7528\u6237\u7684\u4E3A\u51C6 \u793A\u4F8B\u5C5E\u6027\u4F18\u5148\u7EA7\u9AD8\u4E8E\u539F\u578B\u5C5E\u6027\n  scheduler() {\n    this.run();\n  }\n}\n\nexport function effect(fn: () => void, options?: any) {\n  const e = new ReactiveEffect(fn);\n  // scheduler\n  Object.assign(e, options);\n\n  e.run();\n\n  const runner = e.run.bind(e);\n\n  // \u628A effect \u7684\u5C5E\u6027\u653E\u5230\u51FD\u6570\u7684\u5C5E\u6027\u4E2D\n  runner.effect = e;\n\n  return runner;\n}\n", "import { ReactiveEffect } from \"./effect\";\r\n// \u4F9D\u8D56\u9879\r\ninterface Dep {\r\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n  subs: Link | undefined;\r\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n  subsTail: Link | undefined;\r\n}\r\n\r\ninterface Sub {\r\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n  deps: Link | undefined;\r\n  // \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n  depsTail: Link | undefined;\r\n}\r\n\r\n// \u94FE\u8868\u8282\u70B9\r\nexport interface Link {\r\n  // \u4FDD\u5B58 effect\r\n  sub: Sub;\r\n\r\n  // \u4E0B\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\r\n  nextSub: Link | undefined;\r\n  // \u4E0A\u4E00\u4E2A\u8BA2\u9605\u8005\u8282\u70B9\r\n  prevSub: Link | undefined;\r\n  // \u4F9D\u8D56\u9879\r\n  dep: Dep;\r\n  // \u4E0B\u4E00\u4E2A\u4F9D\u8D56\u9879\u8282\u70B9\r\n  nextDep: Link | undefined;\r\n}\r\n\r\n/**\r\n *\u94FE\u63A5\u94FE\u8868\u5173\u7CFB\r\n */\r\nexport function link(dep: any, sub: ReactiveEffect) {\r\n  // \u5C1D\u8BD5\u590D\u7528\u94FE\u8868\u8282\u70B9\r\n  const currentDep = sub.depsTail;\r\n  // \u5206\u4E24\u79CD\u60C5\u51B5\r\n  // \u5982\u679C\u5934\u8282\u70B9\u6709 \u5C3E\u8282\u70B9\u6CA1\u6709 \u5C1D\u8BD5\u590D\u7528\u5934\u8282\u70B9\r\n  // \u5982\u679C\u5C3E\u8282\u70B9\u8FD8\u6709 nextDep \u5C1D\u8BD5\u590D\u7528\u5C3E\u8282\u70B9\u7684 nextDep\r\n  const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep;\r\n  if (nextDep && nextDep.dep === dep) {\r\n    sub.depsTail = nextDep;\r\n    return;\r\n  }\r\n\r\n  // \u5982\u679C\u6709 \u5C31\u4FDD\u5B58\u8D77\u6765 \u66F4\u65B0\u65F6\u89E6\u53D1\r\n  const newLink: Link = {\r\n    sub,\r\n    dep,\r\n    nextSub: undefined,\r\n    prevSub: undefined,\r\n    nextDep: undefined,\r\n  };\r\n\r\n  /**\r\n    \u5C06\u94FE\u8868\u8282\u70B9\u548C dep \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB   \r\n    \u5173\u8054\u94FE\u8868\u5173\u7CFB\r\n    1\uFF1A\u5982\u679C\u6709\u5C3E\u8282\u70B9\u5C31\u5728\u5C3E\u8282\u70B9\u540E\u9762\u6DFB\u52A0\r\n    2\uFF1A\u6CA1\u6709\u5C3E\u8282\u70B9 \u5C31\u662F\u5934\u8282\u70B9\r\n  */\r\n  if (dep.subsTail) {\r\n    dep.subsTail!.nextSub = newLink;\r\n    newLink.prevSub = dep.subsTail;\r\n    dep.subsTail = newLink;\r\n  } else {\r\n    dep.subs = newLink;\r\n    dep.subsTail = newLink;\r\n  }\r\n\r\n  /**\r\n    \u5C06\u94FE\u8868\u8282\u70B9\u548C sub \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB   \r\n    \u5173\u8054\u94FE\u8868\u5173\u7CFB\r\n    1\uFF1A\u5982\u679C\u6709\u5C3E\u8282\u70B9\u5C31\u5728\u5C3E\u8282\u70B9\u540E\u9762\u6DFB\u52A0\r\n    2\uFF1A\u6CA1\u6709\u5C3E\u8282\u70B9 \u5C31\u662F\u5934\u8282\u70B9\r\n  */\r\n\r\n  if (sub.depsTail) {\r\n    sub.depsTail.nextDep = newLink;\r\n    sub.depsTail = newLink;\r\n  } else {\r\n    sub.deps = newLink;\r\n    sub.depsTail = newLink;\r\n  }\r\n}\r\n\r\n/**\r\n * \u901A\u77E5effect\u66F4\u65B0 \u89E6\u53D1subs \u62FF\u5230\u6700\u65B0\u7684\u503C\r\n * @param subs\r\n */\r\nexport function propagete(subs: Link | undefined) {\r\n  //\u901A\u77E5effect\u66F4\u65B0 \u89E6\u53D1subs \u62FF\u5230\u6700\u65B0\u7684\u503C\r\n  let link = subs;\r\n  let queuedEffects = [];\r\n  while (link) {\r\n    queuedEffects.push(link.sub);\r\n    link = link.nextSub;\r\n  }\r\n  queuedEffects.forEach((effect) => effect.notify());\r\n}\r\n", "import { activeSub } from \"./effect\";\nimport { link, propagete, Link } from \"./system\";\n\nenum ReactiveFlags {\n  IS_REF = \"__v_isRef\",\n}\n\n/**\n *  Ref \u7684\u7C7B\n */\nclass RefImpl {\n  //\u4FDD\u5B58\u5B9E\u9645\u7684\u503C\n  _value: unknown;\n  // ref\u6807\u8BB0 \u8BC1\u660E\u662F\u4E00\u4E2Aref\n  __v_isRef = true;\n\n  /**\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\n   */\n  subs: Link | undefined;\n\n  /**\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\n   */\n  subsTail: Link | undefined;\n\n  constructor(value) {\n    this._value = value;\n  }\n\n  get value() {\n    // \u6536\u96C6\u4F9D\u8D56\n    if (activeSub) {\n      trackRef(this);\n    }\n    return this._value;\n  }\n  set value(newValue) {\n    this._value = newValue;\n    triggerRef(this);\n  }\n}\n\nexport function ref(value) {\n  return new RefImpl(value);\n}\n\n/**\n * \u5224\u65AD\u662F\u4E0D\u662F\u4E00\u4E2Aref\n */\nexport function isRef(value) {\n  return !!(value && value[ReactiveFlags.IS_REF]);\n}\n\n/**\n * \u6536\u96C6\u4F9D\u8D56 \u5EFA\u7ACB effect \u4E0E ref \u4E4B\u95F4\u7684\u94FE\u8868\u5173\u7CFB\n * @param dep\n */\nexport function trackRef(dep: RefImpl) {\n  if (activeSub) {\n    link(dep, activeSub);\n  }\n}\n\n/**\n * \u89E6\u53D1\u4F9D\u8D56 ref \u5173\u8054\u7684 effect \u91CD\u65B0\u6267\u884C\n * @param dep\n */\nexport function triggerRef(dep: RefImpl) {\n  if (dep.subs) {\n    propagete(dep.subs);\n  }\n}\n"],
  "mappings": ";AAGO,IAAI;AAEJ,IAAM,iBAAN,MAAqB;AAAA,EAK1B,YAAmB,IAAgB;AAAhB;AAAA,EAAiB;AAAA;AAAA,EAHpC;AAAA;AAAA,EAEA;AAAA,EAEA,MAAM;AAEJ,UAAM,UAAU;AAEhB,gBAAY;AACZ,SAAK,WAAW;AAChB,QAAI;AACF,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AAEA,kBAAY;AAAA,IACd;AAAA,EACF;AAAA;AAAA,EAIA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AAAA;AAAA,EAGA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AACF;AAEO,SAAS,OAAO,IAAgB,SAAe;AACpD,QAAM,IAAI,IAAI,eAAe,EAAE;AAE/B,SAAO,OAAO,GAAG,OAAO;AAExB,IAAE,IAAI;AAEN,QAAM,SAAS,EAAE,IAAI,KAAK,CAAC;AAG3B,SAAO,SAAS;AAEhB,SAAO;AACT;;;AChBO,SAAS,KAAK,KAAU,KAAqB;AAElD,QAAM,aAAa,IAAI;AAIvB,QAAM,UAAU,eAAe,SAAY,IAAI,OAAO,WAAW;AACjE,MAAI,WAAW,QAAQ,QAAQ,KAAK;AAClC,QAAI,WAAW;AACf;AAAA,EACF;AAGA,QAAM,UAAgB;AAAA,IACpB;AAAA,IACA;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,IACT,SAAS;AAAA,EACX;AAQA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAU,UAAU;AACxB,YAAQ,UAAU,IAAI;AACtB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AASA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAS,UAAU;AACvB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AACF;AAMO,SAAS,UAAU,MAAwB;AAEhD,MAAIA,QAAO;AACX,MAAI,gBAAgB,CAAC;AACrB,SAAOA,OAAM;AACX,kBAAc,KAAKA,MAAK,GAAG;AAC3B,IAAAA,QAAOA,MAAK;AAAA,EACd;AACA,gBAAc,QAAQ,CAACC,YAAWA,QAAO,OAAO,CAAC;AACnD;;;ACzFA,IAAM,UAAN,MAAc;AAAA;AAAA,EAEZ;AAAA;AAAA,EAEA,YAAY;AAAA;AAAA;AAAA;AAAA,EAKZ;AAAA;AAAA;AAAA;AAAA,EAKA;AAAA,EAEA,YAAY,OAAO;AACjB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAQ;AAEV,QAAI,WAAW;AACb,eAAS,IAAI;AAAA,IACf;AACA,WAAO,KAAK;AAAA,EACd;AAAA,EACA,IAAI,MAAM,UAAU;AAClB,SAAK,SAAS;AACd,eAAW,IAAI;AAAA,EACjB;AACF;AAEO,SAAS,IAAI,OAAO;AACzB,SAAO,IAAI,QAAQ,KAAK;AAC1B;AAKO,SAAS,MAAM,OAAO;AAC3B,SAAO,CAAC,EAAE,SAAS,MAAM,wBAAoB;AAC/C;AAMO,SAAS,SAAS,KAAc;AACrC,MAAI,WAAW;AACb,SAAK,KAAK,SAAS;AAAA,EACrB;AACF;AAMO,SAAS,WAAW,KAAc;AACvC,MAAI,IAAI,MAAM;AACZ,cAAU,IAAI,IAAI;AAAA,EACpB;AACF;",
  "names": ["link", "effect"]
}
