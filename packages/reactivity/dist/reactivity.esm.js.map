{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["// \u7528\u6765\u4FDD\u5B58\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684effect\r\nexport let activeSub;\r\n\r\nexport class ReactiveEffect {\r\n  constructor(public fn: () => void) {}\r\n  run() {\r\n    // \u6BCF\u6B21\u6267\u884Cfn\u4E4B\u524D \u628Athis \u653E\u5230 activeSub\u4E0A\r\n    activeSub = this;\r\n    try {\r\n      return this.fn();\r\n    } finally {\r\n      // \u6267\u884C\u5B8C\u6BD5\u540E \u628AactiveSub\u7F6E\u4E3Aundefined\r\n      activeSub = undefined;\r\n    }\r\n  }\r\n}\r\n\r\nexport function effect(fn: () => void) {\r\n  const e = new ReactiveEffect(fn);\r\n  e.run();\r\n}\r\n", "import { ReactiveEffect } from \"./effect\";\r\n\r\n// \u94FE\u8868\u8282\u70B9\r\nexport interface Link {\r\n  // \u4FDD\u5B58 effect\r\n  sub: ReactiveEffect;\r\n  // \u4E0B\u4E00\u4E2A\u8282\u70B9\r\n  nextSub: Link | undefined;\r\n  // \u4E0A\u4E00\u4E2A\u8282\u70B9\r\n  prevSub: Link | undefined;\r\n}\r\n\r\n/**\r\n *\u94FE\u63A5\u94FE\u8868\u5173\u7CFB\r\n */\r\nexport function link(dependent: any, sub: ReactiveEffect) {\r\n  // \u5982\u679C\u6709 \u5C31\u4FDD\u5B58\u8D77\u6765 \u66F4\u65B0\u65F6\u89E6\u53D1\r\n  const newLink: Link = {\r\n    sub,\r\n    nextSub: undefined,\r\n    prevSub: undefined,\r\n  };\r\n  /**\r\n       *\u5173\u8054\u94FE\u8868\u5173\u7CFB\r\n       1\uFF1A\u5982\u679C\u6709\u5C3E\u8282\u70B9\u5C31\u5728\u5C3E\u8282\u70B9\u540E\u9762\u6DFB\u52A0\r\n       2\uFF1A\u6CA1\u6709\u5C3E\u8282\u70B9 \u5C31\u662F\u5934\u8282\u70B9\r\n       */\r\n  if (dependent.subsTail) {\r\n    dependent.subsTail!.nextSub = newLink;\r\n    newLink.prevSub = dependent.subsTail;\r\n    dependent.subsTail = newLink;\r\n  } else {\r\n    dependent.subs = newLink;\r\n    dependent.subsTail = newLink;\r\n  }\r\n}\r\n\r\n/**\r\n * \u901A\u77E5effect\u66F4\u65B0 \u89E6\u53D1subs \u62FF\u5230\u6700\u65B0\u7684\u503C\r\n * @param subs\r\n */\r\nexport function propagete(subs: Link | undefined) {\r\n  //\u901A\u77E5effect\u66F4\u65B0 \u89E6\u53D1subs \u62FF\u5230\u6700\u65B0\u7684\u503C\r\n  let link = subs;\r\n  let queuedEffects = [];\r\n  while (link) {\r\n    queuedEffects.push(link.sub);\r\n    link = link.nextSub;\r\n  }\r\n  queuedEffects.forEach((effect) => effect.run());\r\n}\r\n", "import { activeSub } from \"./effect\";\r\nimport { link, propagete, Link } from \"./system\";\r\nenum ReactiveFlags {\r\n  IS_REF = \"__v_isRef\",\r\n}\r\n\r\n/**\r\n *  Ref \u7684\u7C7B\r\n */\r\n\r\nclass RefImpl {\r\n  //\u4FDD\u5B58\u5B9E\u9645\u7684\u503C\r\n  _value;\r\n  // ref\u6807\u8BB0 \u8BC1\u660E\u662F\u4E00\u4E2Aref\r\n  __v_isRef = true;\r\n\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5934\u8282\u70B9\r\n   */\r\n  subs: Link | undefined;\r\n\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u7684\u5C3E\u8282\u70B9\r\n   */\r\n  subsTail: Link | undefined;\r\n\r\n  constructor(value) {\r\n    this._value = value;\r\n  }\r\n\r\n  get value() {\r\n    console.log(\"\u6709\u4EBA\u8BBF\u95EE\u4E86\", activeSub);\r\n    // \u6536\u96C6\u4F9D\u8D56\r\n    if (activeSub) {\r\n      trackRef(this);\r\n    }\r\n    return this._value;\r\n  }\r\n  set value(newValue) {\r\n    console.log(\"\u89E6\u53D1\u4FEE\u6539\u4E86\");\r\n    this._value = newValue;\r\n    triggerRef(this);\r\n  }\r\n}\r\n\r\nexport function ref(value) {\r\n  return new RefImpl(value);\r\n}\r\n\r\n/**\r\n * \u5224\u65AD\u662F\u4E0D\u662F\u4E00\u4E2Aref\r\n */\r\nexport function isRef(value) {\r\n  return !!(value && value[ReactiveFlags.IS_REF]);\r\n}\r\n\r\n/**\r\n * \u6536\u96C6\u4F9D\u8D56 \u5EFA\u7ACB effect \u4E0E ref \u4E4B\u95F4\u7684\u94FE\u8868\u5173\u7CFB\r\n * @param dependent\r\n */\r\nexport function trackRef(dependent: RefImpl) {\r\n  if (activeSub) {\r\n    link(dependent, activeSub);\r\n  }\r\n}\r\n\r\n/**\r\n * \u89E6\u53D1\u4F9D\u8D56 ref \u5173\u8054\u7684 effect \u91CD\u65B0\u6267\u884C\r\n * @param dependent\r\n */\r\nexport function triggerRef(dependent: RefImpl) {\r\n  if (dependent.subs) {\r\n    propagete(dependent.subs);\r\n  }\r\n}\r\n"],
  "mappings": ";AACO,IAAI;AAEJ,IAAM,iBAAN,MAAqB;AAAA,EAC1B,YAAmB,IAAgB;AAAhB;AAAA,EAAiB;AAAA,EACpC,MAAM;AAEJ,gBAAY;AACZ,QAAI;AACF,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AAEA,kBAAY;AAAA,IACd;AAAA,EACF;AACF;AAEO,SAAS,OAAO,IAAgB;AACrC,QAAM,IAAI,IAAI,eAAe,EAAE;AAC/B,IAAE,IAAI;AACR;;;ACLO,SAAS,KAAK,WAAgB,KAAqB;AAExD,QAAM,UAAgB;AAAA,IACpB;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,EACX;AAMA,MAAI,UAAU,UAAU;AACtB,cAAU,SAAU,UAAU;AAC9B,YAAQ,UAAU,UAAU;AAC5B,cAAU,WAAW;AAAA,EACvB,OAAO;AACL,cAAU,OAAO;AACjB,cAAU,WAAW;AAAA,EACvB;AACF;AAMO,SAAS,UAAU,MAAwB;AAEhD,MAAIA,QAAO;AACX,MAAI,gBAAgB,CAAC;AACrB,SAAOA,OAAM;AACX,kBAAc,KAAKA,MAAK,GAAG;AAC3B,IAAAA,QAAOA,MAAK;AAAA,EACd;AACA,gBAAc,QAAQ,CAACC,YAAWA,QAAO,IAAI,CAAC;AAChD;;;ACxCA,IAAM,UAAN,MAAc;AAAA;AAAA,EAEZ;AAAA;AAAA,EAEA,YAAY;AAAA;AAAA;AAAA;AAAA,EAKZ;AAAA;AAAA;AAAA;AAAA,EAKA;AAAA,EAEA,YAAY,OAAO;AACjB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAQ;AACV,YAAQ,IAAI,kCAAS,SAAS;AAE9B,QAAI,WAAW;AACb,eAAS,IAAI;AAAA,IACf;AACA,WAAO,KAAK;AAAA,EACd;AAAA,EACA,IAAI,MAAM,UAAU;AAClB,YAAQ,IAAI,gCAAO;AACnB,SAAK,SAAS;AACd,eAAW,IAAI;AAAA,EACjB;AACF;AAEO,SAAS,IAAI,OAAO;AACzB,SAAO,IAAI,QAAQ,KAAK;AAC1B;AAKO,SAAS,MAAM,OAAO;AAC3B,SAAO,CAAC,EAAE,SAAS,MAAM,wBAAoB;AAC/C;AAMO,SAAS,SAAS,WAAoB;AAC3C,MAAI,WAAW;AACb,SAAK,WAAW,SAAS;AAAA,EAC3B;AACF;AAMO,SAAS,WAAW,WAAoB;AAC7C,MAAI,UAAU,MAAM;AAClB,cAAU,UAAU,IAAI;AAAA,EAC1B;AACF;",
  "names": ["link", "effect"]
}
